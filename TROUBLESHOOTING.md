# 会话模式问题排查

## 当前问题

请求超时，可能的原因：

1. **gemini 不支持通过 stdin 持续交互**
   - gemini 可能不是设计为通过 stdin 持续接收输入的
   - 可能需要使用特定的交互模式参数

2. **响应解析逻辑问题**
   - 无法正确识别响应何时结束
   - 需要根据 gemini 的实际输出格式调整

3. **进程启动问题**
   - 进程可能没有正确启动
   - 或者启动后立即退出

## 调试步骤

### 1. 检查进程是否启动

在 PyCharm 或终端中查看服务器日志，应该能看到：
- `[DEBUG] 发送消息: ...`
- `[DEBUG] 消息已发送，等待响应...`
- `[DEBUG] 等待响应中...`

### 2. 检查 gemini 进程

```bash
# 查看是否有 gemini 进程在运行
ps aux | grep gemini | grep -v grep
```

### 3. 测试 gemini 交互模式

手动测试 gemini 是否支持交互模式：

```bash
# 测试 1：直接启动 gemini
echo "你好" | gemini --approval-mode yolo

# 测试 2：交互模式
gemini --prompt-interactive "你好" --approval-mode yolo
```

### 4. 查看服务器日志

检查 PyCharm 控制台或终端输出，查看：
- 是否有错误信息
- 进程是否启动成功
- stdout 读取线程是否正常工作

## 可能的解决方案

### 方案 1：使用会话文件（--resume）

如果长连接不可行，可以使用 gemini 的会话文件功能：

```python
# 每次请求后保存会话
# 下次请求时使用 --resume 恢复
```

### 方案 2：改进响应解析

根据 gemini 的实际输出格式，调整响应解析逻辑：
- 检测特定的结束标记
- 使用更长的超时时间
- 检测进程退出信号

### 方案 3：回退到普通模式

如果会话模式实现复杂，可以：
- 继续使用普通模式（每次新进程）
- 或者使用会话文件来保持上下文

## 下一步

1. 查看服务器日志，确认问题
2. 测试 gemini 是否支持交互模式
3. 根据实际情况调整实现
